@page "/gameList"
@using GameStore.Client.Services.ApiClients
@inject NavigationManager NavigationManager  
@inject IGamesClient gamesClient
@inject IGenresClient genresClient
@rendermode InteractiveWebAssembly

<PageTitle>Game Catalog</PageTitle>  

<AuthorizeView Roles="Admin">
	<div class="mt-2">  
		<NavLink class="btn btn-primary" href="/EditGame">New Game</NavLink>  
	</div>  
</AuthorizeView>

@if (games == null)  
{  
	<p><em>Loading...</em></p>  
}  
else  
{  
	<div class="search-container mb-4" style="margin-top: 20px;">
		<div class="search-box">
			<i class="bi bi-search search-icon"></i>
			<InputText class="search-input form-control" placeholder="Search games..." 
			           @bind-Value="SearchTerm" @oninput="(e) => SearchTerm = e.Value?.ToString() ?? string.Empty" />
			@if (!string.IsNullOrEmpty(SearchTerm))
			{
				<button class="clear-search" @onclick="() => SearchTerm = string.Empty">
					<i class="bi bi-x"></i>
				</button>
			}
		</div>
		<div class="search-results-info">
			Showing @pagedGames.Count() of @filteredGames.Count() results
			@if (!string.IsNullOrEmpty(SearchTerm))
			{
				<span>for "@SearchTerm"</span>
			}
		</div>
	</div>

	<div class="row row-cols-1 row-cols-md-3 g-4" style="margin-top: 30px;">
		@foreach (var game in pagedGames)
		{
			<div class="col">
				<div class="card h-100 position-relative" style="cursor: pointer;">
					<div @onclick="@(() => GoToDetails(game.GameId))" >
						<img src="@game.ImageUrl" class="card-img-top" alt="@game.Name" style="height: 200px; object-fit: cover;"/>
						<div class="card-body">
							<h5 class="card-title">@game.Name</h5>
							<p class="card-text">
								Genre: @genres.FirstOrDefault(g => g.GenreId == game.GenreId)?.Name <br/>
								Price: $@game.Price <br/>
								Release: @game.ReleaseDate.ToShortDateString()
							</p>
						</div>
					</div>

					<AuthorizeView Roles="Admin">
						<div class="m-2 d-flex">
							<button class="btn btn-primary me-2" @onclick="@(() => GoToEdit(game.GameId))">
								<i class="bi bi-pencil"></i>
							</button>
							<button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="@GetDeleteModalId(game)">Delete</button>
						</div>
						<DeleteGame Game="@game"/>
					</AuthorizeView>
				</div>
			</div>
		}
	</div>

	@* <div class="d-flex justify-content-center mt-4">
		<button class="btn @(!(currentPage > 1) ? "btn-secondary" : "btn-info") me-2" @onclick="PreviousPage" disabled="@(!(currentPage > 1))">Previous</button>
		@foreach (var page in GetVisiblePages())
		{
			if (page == -1)
			{
				<span class="mx-2">...</span>
			}
			else
			{
				<button class="btn @(page == currentPage ? "btn-dark" : "btn-outline-secondary")" @onclick="@(() => ChangePage(page))">@Convert.ToString(page)</button>
			}
		}
		<button class="btn @(!(currentPage < totalPages) ? " btn-secondary" : "btn-info" ) ms-2" @onclick="NextPage" disabled="@(!(currentPage < totalPages))">Next</button>
	</div> *@

	<div class="d-flex flex-column align-center">
		<MudPagination BoundaryCount="1" MiddleCount="1" Count="totalPages" @bind-Selected="@currentPage" Class="mt-4" />
	</div>
}  

@code {
	private List<Game>? games;  
	private List<Genre>? genres;
	private int currentPage = 1;
	private int pageSize = 3;
	private IEnumerable<Game> pagedGames => filteredGames.Skip((currentPage - 1) * pageSize).Take(pageSize);
	private int totalPages => (int)Math.Ceiling((double)filteredGames.Count() / pageSize);

	private string searchTerm = string.Empty;
	private string SearchTerm
	{
		get => searchTerm;
		set
		{
			searchTerm = value;
			currentPage = 1;
		}
	}

	private IEnumerable<Game> filteredGames =>
		string.IsNullOrWhiteSpace(SearchTerm) ? games : games.Where(g => g.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

	protected override async Task OnInitializedAsync()
	{
		games = await gamesClient.GetGamesAsync();
		genres = await genresClient.GetGenresAsync();
	}  

	private string GetDeleteModalId(Game game)  
	{  
		return $"#{DeleteGame.GetModalId(game)}";  
	}  

	private void GoToEdit(int id)  
	{  
		NavigationManager.NavigateTo($"/EditGame/{id}");  
	}

	private void GoToDetails(int id)
	{
		NavigationManager.NavigateTo($"/GameDetails/{id}");
	}

	private void PreviousPage()
	{
		if (currentPage > 1)
		{
			currentPage--;
		}
	}

	private void NextPage()
	{
		if (currentPage < totalPages)
		{
			currentPage++;
		}
	}

	private void ChangePage(int page)
	{
		if (page >= 1 && page <= totalPages)
		{
			currentPage = page;
		}
	}

	private IEnumerable<int> GetVisiblePages()
	{
		const int maxVisibleRange = 1;
		List<int> pages = new();
		pages.Add(1);
		if (currentPage - maxVisibleRange > 2)
		{
			pages.Add(-1);
		}
		for (int i = currentPage - maxVisibleRange; i <= currentPage + maxVisibleRange; i++)
		{
			if (i > 1 && i < totalPages)
			{
				pages.Add(i);
			}
		}
		if (currentPage + maxVisibleRange < totalPages - 1)
		{
			pages.Add(-1);
		}
		if (totalPages > 1)
		{
			pages.Add(totalPages);
		}
		return pages.Distinct();
	}
}